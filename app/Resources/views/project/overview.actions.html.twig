<script type="text/javascript">
    $('document').ready(function () {
        $('#project-table').DataTable( {
            ajax: {
                url: '{{ path('api_listing_projects', {'dbversion': dbversion}) }}',
                dataSrc: 'data',
                complete: function(){
                    addProjectTableActionButtonFunctionality();
                }
            },
            columns: [
                { data: 'id' },
                { data: 'import_filename' },
                { data: 'import_date' },
                { data: 'rows' },
                { data: 'columns' },
                { data: 'permissionStatus'},
                { data: null }
            ],
            columnDefs: [
                {
                    targets: 0,
                    render: function (data, type, full, meta) {
                        console.log(full);
                        var href = Routing.generate('project_details', {'dbversion': '{{ dbversion}}', 'project_id': full.internal_project_id, 'attribute': full.permissionStatus});
                        return '<a href="'+href+'">'+full.id+'</a>';
                    }
                },
                {
                    targets: -1,
                    data: null,
                    render: function(data, type, full, meta){
                        return "<a class=\"btn fa fa-trash project-remove-button\" data-toggle=\"confirFeditation\"></a>{% if is_granted('owner', 35) %}<a class=\"btn fa fa-share-alt project-share-button\" data-toggle=\"confirFeditation\"></a>{% endif %}"
                    }
                }
            ],
            drawCallback: function( settings ) {
                addProjectTableActionButtonFunctionality();
            }
        } );

        function addProjectTableActionButtonFunctionality(){
            $('.project-remove-button').confirmation({
                onConfirm: function(event, element){
                    var table = $('#project-table').DataTable({
                        retrieve: true
                    });
                    var data = table.row( $(this).parents('tr') ).data();
                    var url = Routing.generate('api_delete_projects', {'projectId': data.internal_project_id, 'dbversion': dbversion });
                    $.ajax({
                        url: url,
                        type: 'GET',
                        cache: false,
                        dataType: 'json',
                        /* jshint unused:vars */
                        success: function(data, textStatus, jqXHR)
                        {
                            var deleted = data.deletedProjects;
                            showMessageDialog(deleted+" project"+(deleted > 1 ? "s" : "")+" deleted successfully", 'alert-success');
                            $('#project-table').DataTable({
                                retrieve: true
                            }).ajax.reload();
                        },
                        error: function(jqXHR, textStatus, errorThrown)
                        {
                            showMessageDialog("There was an error: "+textStatus, 'alert-danger');
                        }
                    });
                }
            });
            $('.project-share-button').confirm({
                title: 'Prompt!',
                content: '' +
                '<form action="" class="formName">' +
                '<div class="form-group">' +
                '<label>Enter something here</label>' +
                '<input type="text" placeholder="Your name" class="name form-control" required />' +
                '</div>' +
                '</form>',
                buttons: {
                    formSubmit: {
                        text: 'Submit',
                        btnClass: 'btn-blue',
                        action: function () {
                            var name = this.$content.find('.name').val();
                            //check ob gÃ¼ltige email evtl ob email existiert
                            //check ob permission passt
                            //webservice aufrufen der project mit einem anderen nutzer teilt
                            if(!name){
                                $.alert('provide a valid mail');
                                return false;
                            }
                            $.alert('Your name is ' + name);
                        }
                    },
                    cancel: function () {
                        //close
                    },
                },
                onContentReady: function () {
                    // bind to events
                    var jc = this;
                    this.$content.find('form').on('submit', function (e) {
                        // if the user submits the form by pressing enter in the field.
                        e.preventDefault();
                        jc.$$formSubmit.trigger('click'); // reference the button and click it
                    });
                }
            });
        }

        // The procedure here in is adjusted from the plugin https://github.com/Abban/jQuery-Ajax-File-Upload
        // available under MIT License
        // description on: http://abandon.ie/notebook/simple-file-uploads-using-jquery-ajax

        // Upload files on change of file selector
        $('#project-fileupload').on('change', startProjectFileUpload);

        /* globals FormData */
        /**
         * Start upload of selected files to the server
         * @param {event} event
         * @returns {void}
         */
        function startProjectFileUpload(event)
        {
            $('#project-upload-busy-indicator').show();
            var files = event.target.files;
            var data = new FormData();
            $.each(files, function(key, value)
            {
                data.append(key, value);
            });
            var url = Routing.generate('api_upload_projects', { 'dbversion': dbversion });
            $.ajax({
                url: url,
                type: 'POST',
                data: data,
                cache: false,
                dataType: 'json',
                processData: false, // Don't process the files
                contentType: false, // Set content type to false as jQuery will tell the server its a query string request
                /* jshint unused:vars */
                success: function(data, textStatus, jqXHR)
                {
                    var successfulUploads = 0;
                    $.each(data.files, function(key, value){
                        if(value.error !== null){
                            showMessageDialog("Error uploading "+value.name+": "+value.error, 'alert-danger');
                        } else {
                            successfulUploads++;
                        }
                    });
                    if(successfulUploads > 0){
                        showMessageDialog(successfulUploads+" project"+(successfulUploads > 1 ? "s" : "")+" uploaded successfully", 'alert-success');
                    }
                    $('#project-table').DataTable({
                        retrieve: true
                    }).ajax.reload();
                    $('#project-upload-busy-indicator').hide();
                },
                error: function(jqXHR, textStatus, errorThrown)
                {
                    showMessageDialog("There was an error: "+textStatus, 'alert-danger');
                    $('#project-upload-busy-indicator').hide();
                }
            });
        }
    })
</script>
